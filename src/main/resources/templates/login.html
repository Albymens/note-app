<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Login - Notes App</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
</head>
<body>
<div class="auth-card">
    <h2 class="text-center mb-4">üîê Sign In</h2>

    <!-- Success message from signup -->
    <div th:if="${param.message}" class="alert alert-success">
        ‚úÖ <span th:text="${param.message}"></span>
    </div>

    <!-- Server-side error messages -->
    <div th:if="${error}" class="alert alert-error">
        ‚ùå <span th:text="${error}"></span>
    </div>

    <form id="loginForm">
        <div class="form-group">
            <label for="username">Username or Email *</label>
            <input type="text" id="username" name="usernameOrEmail" class="form-control" placeholder="Enter your username or email" required>
            <div id="usernameError" class="text-danger mt-1" style="font-size: 12px;"></div>
        </div>

        <div class="form-group">
            <label for="password">Password *</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required>
            <div id="passwordError" class="text-danger mt-1" style="font-size: 12px;"></div>
        </div>

        <button type="submit" id="loginBtn" class="btn btn-primary">
            <span id="loginText">Login</span>
            <span id="loginSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
        </button>
    </form>

    <div id="clientResult" class="mt-3"></div>

    <div class="signup-link">
        <p>Don't have an account? <a th:href="@{/signup}">Create one</a></p>
    </div>
</div>

<script>
    $(document).ready(function() {
        // If already logged in, redirect
        const token = localStorage.getItem('token');
        if (token) {
            validateTokenAndRedirect(token);
        }

        // Handle form submission
        $('#loginForm').submit(function(e) {
            e.preventDefault();
            login();
        });

        // Clear field-specific errors
        $('input').on('input', function() {
            $(this).removeClass('is-invalid');
            $('#' + this.id + 'Error').text('');
            $('#clientResult').empty();
        });
    });

    function validateTokenAndRedirect(token) {
        $.ajax({
            url: '/api/auth/validate',
            headers: { 'Authorization': 'Bearer ' + token },
            success: function() {
                window.location.href = '/notes';
            },
            error: function() {
                localStorage.removeItem('token');
            }
        });
    }

    function login() {
        const credentials = {
            usernameOrEmail: $('#username').val().trim(),
            password: $('#password').val()
        };

        if (!credentials.usernameOrEmail || !credentials.password) {
            showClientError('Please fill in all required fields');
            return;
        }

        $('#loginBtn').prop('disabled', true);
        $('#loginText').hide();
        $('#loginSpinner').show();

        $.ajax({
            url: '/api/auth/login',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(credentials),
            success: function(response) {
                const token = response.token || response.accessToken;
                if (token) {
                    localStorage.setItem('token', token);
                    showClientSuccess('Login successful! Redirecting...');
                    setTimeout(() => window.location.href = '/notes', 1500);
                } else {
                    showClientError('Unexpected response. Please try again.');
                }
            },
            error: function(xhr) {
                $('#loginBtn').prop('disabled', false);
                $('#loginText').show();
                $('#loginSpinner').hide();

                if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.data) {
                    handleValidationErrors(xhr.responseJSON.data);
                } else if (xhr.responseJSON && xhr.responseJSON.message) {
                    showClientError(xhr.responseJSON.message);
                } else {
                    showClientError('Invalid username or password.');
                }
            }
        });
    }

    function handleValidationErrors(errors) {
        $('.is-invalid').removeClass('is-invalid');
        $('.text-danger').text('');

        Object.keys(errors).forEach(field => {
            const errorElement = $('#' + field + 'Error');
            const inputElement = $('#' + field);
            if (errorElement.length && inputElement.length) {
                inputElement.addClass('is-invalid');
                errorElement.text(errors[field]);
            }
        });

        if (Object.keys(errors).length === 0) {
            showClientError('Please check your input and try again.');
        }
    }

    function showClientError(message) {
        $('#clientResult').html(
            '<div class="alert alert-error">‚ùå ' + message + '</div>'
        );
    }

    function showClientSuccess(message) {
        $('#clientResult').html(
            '<div class="alert alert-success">‚úÖ ' + message + '</div>'
        );
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            const token = localStorage.getItem('token');
            if (token) {
                validateTokenAndRedirect(token);
            }
        }
    });
</script>
</body>
</html>
