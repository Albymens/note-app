<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Notes</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .note-card {
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .note-card.deleted {
            opacity: 0.7;
            background: #fff3f3;
        }
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.5rem;
            display: inline-block;
        }
        .loading-spinner {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .btn {
            border-radius: 6px;
            font-weight: 500;
        }
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .is-invalid {
            border-color: #dc3545 !important;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="#">
            <i class="bi bi-journal-text"></i> Notes App
        </a>
        <div class="navbar-nav ms-auto align-items-center">
                <span class="navbar-text me-3" th:if="${username}">
                    <i class="bi bi-person-circle"></i> <span th:text="${username}">User</span>
                </span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid">
    <!-- Search and Filters -->
    <div class="search-section">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Search Notes</label>
                <div class="input-group">
                    <input type="text" id="search" class="form-control" placeholder="Search by title or content...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchNotes()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Filter by Tags</label>
                <input type="text" id="tagsFilter" class="form-control" placeholder="java, spring, notes...">
            </div>
            <div class="col-md-3">
                <label class="form-label fw-semibold">Sort By</label>
                <div class="input-group">
                    <select id="sortBy" class="form-select">
                        <option value="createdAt">Date Created</option>
                        <option value="updatedAt">Last Updated</option>
                        <option value="title">Title</option>
                    </select>
                    <select id="sortDirection" class="form-select">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="showCreateModal()">
                    <i class="bi bi-plus-lg"></i> New Note
                </button>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                    <i class="bi bi-arrow-clockwise"></i> Clear Filters
                </button>
                <span id="resultsCount" class="text-muted ms-2"></span>
            </div>
        </div>
    </div>

    <!-- Notes Container -->
    <div id="notesContainer">
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your notes...</p>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;"></div>

        <div id="notesList" class="row" style="display: none;"></div>
    </div>

    <!-- Pagination -->
    <nav id="pagination" class="d-flex justify-content-center mt-4"></nav>
</div>

<!-- Create/Edit Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-journal-plus"></i> Create New Note
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId">

                    <div class="mb-3">
                        <label for="noteTitle" class="form-label fw-semibold">Title *</label>
                        <input type="text" class="form-control" id="noteTitle" placeholder="Enter note title" required>
                        <div id="titleError" class="form-text text-danger"></div>
                    </div>

                    <div class="mb-3">
                        <label for="noteContent" class="form-label fw-semibold">Content</label>
                        <textarea class="form-control" id="noteContent" placeholder="Enter your note content..." rows="8"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="noteTags" class="form-label fw-semibold">Tags</label>
                        <input type="text" class="form-control" id="noteTags" placeholder="Enter tags separated by commas (e.g., java, spring, notes)">
                        <div class="form-text">Separate multiple tags with commas</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn" onclick="saveNote()">
                    <span id="saveNoteText">Save Note</span>
                    <span id="saveNoteSpinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global state
    let currentPage = 0;
    const pageSize = 10;
    let noteModalInstance = null;

    $(document).ready(function() {
        // Initialize Bootstrap modal
        noteModalInstance = new bootstrap.Modal(document.getElementById('noteModal'));

        const token = localStorage.getItem('token');

        if (!token) {
            redirectToLogin('Please login to access your notes');
            return;
        }

        // Event listeners
        $('#search').on('keyup', debounce(searchNotes, 300));
        $('#tagsFilter').on('keyup', debounce(searchNotes, 300));
        $('#sortBy, #sortDirection').change(searchNotes);

        // Validate token and load notes
        validateTokenAndLoadNotes(token);
    });

     $('#noteModal').on('show.bs.modal', function () {
        $('#saveNoteBtn').prop('disabled', false);
        $('#saveNoteText').text('Save Note');
        clearModalErrors();
    });

    function validateTokenAndLoadNotes(token) {
        $.ajax({
            url: '/api/auth/validate',
            headers: { 'Authorization': 'Bearer ' + token },
            success: function() {
                loadNotes();
            },
            error: function(xhr) {
                handleAuthError(xhr);
            }
        });
    }

    function loadNotes(page = 0) {
        currentPage = page;

        const searchTerm = $('#search').val();
        const tags = $('#tagsFilter').val();
        const sortBy = $('#sortBy').val();
        const sortDirection = $('#sortDirection').val();

        // Build URL according to your backend endpoint
        let url = `/api/notes/search?page=${page}&size=${pageSize}&sort=${sortBy},${sortDirection}`;

        if (searchTerm) {
            url += `&searchTerm=${encodeURIComponent(searchTerm)}`;
        }

        if (tags) {
            const tagsArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            tagsArray.forEach(tag => {
                url += `&tags=${encodeURIComponent(tag)}`;
            });
        }

        showLoadingState();

        $.ajax({
            url: url,
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            success: function(result) {
                const notesPage = result ?.content ? result : result.data;

                displayNotes(notesPage);

                console.log("Rendering notes:", notesPage.content);

                let html = '';
                notesPage.content.forEach(note => {
                    html += `<div class="note">
                        <h3>${note.title}</h3>
                        <p>${note.content || ''}</p>
                        <div><strong>Tags:</strong> ${note.tags.join(", ")}</div>
                        <div><em>By ${note.username}</em></div>
                        <small>Created at: ${new Date(note.createdAt).toLocaleString()}</small>
                    </div>`;
            });
                $("#notes-container").html(html);
            },
            error: function(xhr) {
                if (!handleAuthError(xhr)) {
                    showErrorState('Failed to load notes');
                }
            }
        });
    }

    function searchNotes() {
        loadNotes(0);
    }

    function clearFilters() {
        $('#search').val('');
        $('#tagsFilter').val('');
        $('#sortBy').val('createdAt');
        $('#sortDirection').val('desc');
        loadNotes(0);
    }

    function showLoadingState() {
        $('#loadingSpinner').show();
        $('#notesList').hide();
        $('#emptyState').hide();
    }

    function showErrorState(message) {
        $('#loadingSpinner').hide();
        $('#notesList').hide();
        $('#emptyState').show().html(`
            <div class="text-center">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #dc3545;"></i>
                <h4 class="mt-3">Error Loading Notes</h4>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary mt-2" onclick="loadNotes()">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </div>
        `);
    }

    function displayNotes(notesPage) {
        $('#loadingSpinner').hide();

        if (!notesPage.content || notesPage.content.length === 0) {
            $('#notesList').hide();
            $('#emptyState').show().html(`
                <div class="text-center">
                    <i class="bi bi-journal-x" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">No notes found</h4>
                    <p class="text-muted">${$('#search').val() || $('#tagsFilter').val() ? 'Try adjusting your search filters' : 'Create your first note to get started!'}</p>
                    <button class="btn btn-primary mt-2" onclick="showCreateModal()">
                        <i class="bi bi-plus-lg"></i> Create Note
                    </button>
                </div>
            `);
            $('#pagination').html('');
            $('#resultsCount').text('0 notes found');
            return;
        }

        $('#emptyState').hide();
        $('#notesList').show();

        // Update results count
        $('#resultsCount').text(`${notesPage.totalElements} note${notesPage.totalElements !== 1 ? 's' : ''} found`);

        // Display notes
        const notesHtml = notesPage.content.map(note => {
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card note-card ${note.deletedAt ? 'deleted' : ''}">
                        <div class="card-body">
                            <h5 class="card-title">${escapeHtml(note.title)}</h5>
                            <p class="card-text text-muted">${note.content ? escapeHtml(note.content.substring(0, 100)) + (note.content.length > 100 ? '...' : '') : 'No content'}</p>

                            <div class="mb-2">
                                ${note.tags && note.tags.length > 0 ?
                                    note.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('') :
                                    '<span class="text-muted">No tags</span>'
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    ${formatDate(note.updatedAt || note.createdAt)}
                                    ${note.deletedAt ? '<span class="badge bg-danger ms-1">Deleted</span>' : ''}
                                </small>
                                <div class="btn-group">
                                    ${!note.deletedAt ?
                                        `<button class="btn btn-outline-primary btn-sm" onclick="editNote(${note.id})" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteNote(${note.id})" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>` :
                                        `<button class="btn btn-outline-success btn-sm" onclick="restoreNote(${note.id})" title="Restore">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        $('#notesList').html(notesHtml);
        updatePagination(notesPage);
    }

    function updatePagination(notesPage) {
        const pagination = $('#pagination');
        const totalPages = notesPage.totalPages;

        if (totalPages <= 1) {
            pagination.html('');
            return;
        }

        let paginationHtml = '';

        // Previous button
        paginationHtml += `<li class="page-item ${notesPage.first ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadNotes(${currentPage - 1})" ${notesPage.first ? 'tabindex="-1" aria-disabled="true"' : ''}>
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        </li>`;

        // Page numbers - show limited range around current page
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadNotes(${i})">${i + 1}</a>
            </li>`;
        }

        // Next button
        paginationHtml += `<li class="page-item ${notesPage.last ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadNotes(${currentPage + 1})" ${notesPage.last ? 'tabindex="-1" aria-disabled="true"' : ''}>
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </li>`;

        pagination.html(`<ul class="pagination">${paginationHtml}</ul>`);
    }

    // Modal Functions
    function showCreateModal() {
        $('#modalTitle').html('<i class="bi bi-journal-plus"></i> Create New Note');
        $('#noteId').val('');
        $('#noteTitle').val('');
        $('#noteContent').val('');
        $('#noteTags').val('');
        clearModalErrors();
        noteModalInstance.show();
    }

    function editNote(noteId) {
        $.ajax({
            url: `/api/notes/${noteId}`,
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            success: function(response) {
                // Your backend returns ApiResult with data field
                const note = response.data;
                $('#modalTitle').html('<i class="bi bi-pencil"></i> Edit Note');
                $('#noteId').val(note.id);
                $('#noteTitle').val(note.title);
                $('#noteContent').val(note.content || '');
                $('#noteTags').val(note.tags ? note.tags.join(', ') : '');
                clearModalErrors();
                noteModalInstance.show();
            },
            error: function(xhr) {
                if (!handleAuthError(xhr)) {
                    alert('Error loading note for editing');
                }
            }
        });
    }

    function clearModalErrors() {
        $('.is-invalid').removeClass('is-invalid');
        $('.text-danger').text('');
    }

    function saveNote() {
        const noteId = $('#noteId').val();
        const noteData = {
            title: $('#noteTitle').val().trim(),
            content: $('#noteContent').val(),
            tags: $('#noteTags').val().split(',').map(tag => tag.trim()).filter(tag => tag)
        };

        // Validation
        if (!noteData.title) {
            $('#titleError').text('Title is required');
            $('#noteTitle').addClass('is-invalid');
            return;
        }

        clearModalErrors();

        // Show loading state in modal
        $('#saveNoteBtn').prop('disabled', true);
        $('#saveNoteText').text('Saving...');

        const url = noteId ? `/api/notes/${noteId}` : '/api/notes';
        const method = noteId ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            type: method,
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token'),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(noteData),
            success: function(response) {
                noteModalInstance.hide();
                showToast('Note saved successfully!', 'success');
                loadNotes(currentPage);
            },
            error: function(xhr) {
                $('#saveNoteBtn').prop('disabled', false);
                $('#saveNoteText').text('Save Note');

                if (!handleAuthError(xhr)) {
                    if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.data) {
                        // Show validation errors from your ApiResult
                        const errors = xhr.responseJSON.data;
                        Object.keys(errors).forEach(field => {
                            $(`#${field}Error`).text(errors[field]);
                            $(`#note${field.charAt(0).toUpperCase() + field.slice(1)}`).addClass('is-invalid');
                        });
                    } else {
                        alert('Failed to save note: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    }
                }
            }
        });
    }

    function deleteNote(noteId) {
        if (confirm('Are you sure you want to delete this note? This action can be undone.')) {
            $.ajax({
                url: `/api/notes/${noteId}`,
                type: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                success: function(response) {
                    showToast('Note deleted successfully!', 'success');
                    loadNotes(currentPage);
                },
                error: function(xhr) {
                    if (!handleAuthError(xhr)) {
                        alert('Delete failed: ' + (xhr.responseJSON?.message || 'Unknown error'));
                    }
                }
            });
        }
    }

    function restoreNote(noteId) {
        $.ajax({
            url: `/api/notes/${noteId}/restore`,
            type: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            success: function(response) {
                showToast('Note restored successfully!', 'success');
                loadNotes(currentPage);
            },
            error: function(xhr) {
                if (!handleAuthError(xhr)) {
                    alert('Restore failed: ' + (xhr.responseJSON?.message || 'Unknown error'));
                }
            }
        });
    }

    // Utility Functions
    function handleAuthError(xhr) {
        if (xhr.status === 401 || xhr.status === 403) {
            localStorage.removeItem('token');
            redirectToLogin('Your session has expired. Please login again.');
            return true;
        }
        return false;
    }

    function redirectToLogin(message) {
        if (message) {
            window.location.href = `/login?error=${encodeURIComponent(message)}`;
        } else {
            window.location.href = '/login';
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = $(`
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed top-0 end-0 m-3" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);

        $('body').append(toast);
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();

        // Remove from DOM after hide
        toast.on('hidden.bs.toast', function () {
            $(this).remove();
        });
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/login?logout=true';
        }
    }
</script>
</body>
</html>