<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Signup - Notes App</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/auth.css}">
</head>
<body>
<div class="auth-card">
    <h2 class="text-center mb-4">üìù Create Account</h2>

    <!-- Server-side error messages -->
    <div th:if="${error}" class="alert alert-error">
        ‚ùå <span th:text="${error}"></span>
    </div>

    <form id="signupForm">
        <div class="form-group">
            <label for="username">Username *</label>
            <input type="text" id="username" name="username" class="form-control" placeholder="Choose a username" required>
            <div id="usernameError" class="text-danger mt-1" style="font-size: 12px;"></div>
        </div>

        <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" class="form-control" placeholder="your@email.com" required>
            <div id="emailError" class="text-danger mt-1" style="font-size: 12px;"></div>
        </div>

        <div class="form-group">
            <label for="password">Password *</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="Create a password" required>
            <div id="passwordError" class="text-danger mt-1" style="font-size: 12px;"></div>
        </div>

        <button type="submit" id="signupBtn" class="btn btn-primary">
            <span id="signupText">Create Account</span>
            <span id="signupSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
        </button>
    </form>

    <div id="clientResult" class="mt-3"></div>

    <div class="login-link">
        <p>Already have an account? <a th:href="@{/login}">Sign in</a></p>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Check if already authenticated
        const token = localStorage.getItem('token');
        if (token) {
            validateTokenAndRedirect(token);
        }

        // Form submission handler
        $('#signupForm').submit(function(e) {
            e.preventDefault();
            signup();
        });

        // Clear errors when user starts typing
        $('input').on('input', function() {
            $(this).removeClass('is-invalid');
            $('#' + this.id + 'Error').text('');
            $('#clientResult').empty();
        });
    });

    function validateTokenAndRedirect(token) {
        $.ajax({
            url: '/api/auth/validate',
            headers: { 'Authorization': 'Bearer ' + token },
            success: function() {
                window.location.href = '/notes';
            },
            error: function() {
                localStorage.removeItem('token');
            }
        });
    }

    function signup() {
        const user = {
            username: $('#username').val().trim(),
            email: $('#email').val().trim(),
            password: $('#password').val()
        };

        // Client-side validation
        if (!user.username || !user.email || !user.password) {
            showClientError('Please fill in all required fields');
            return;
        }

        // Show loading state
        $('#signupBtn').prop('disabled', true);
        $('#signupText').hide();
        $('#signupSpinner').show();
        $('#clientResult').empty();

        $.ajax({
            url: '/api/auth/signup',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(user),
            success: function(result) {
                showClientSuccess('Account created successfully! Redirecting to login...');
                setTimeout(() => {
                    window.location.href = '/login?message=Account created successfully. Please login.';
                }, 2000);
            },
            error: function(xhr) {
                $('#signupBtn').prop('disabled', false);
                $('#signupText').show();
                $('#signupSpinner').hide();

                if (xhr.status === 400 && xhr.responseJSON && xhr.responseJSON.data) {
                    // Handle validation errors
                    handleValidationErrors(xhr.responseJSON.data);
                } else if (xhr.responseJSON && xhr.responseJSON.message) {
                    showClientError(xhr.responseJSON.message);
                } else {
                    showClientError('Registration failed. Please try again.');
                }
            }
        });
    }

    function handleValidationErrors(errors) {
        // Clear previous errors
        $('.is-invalid').removeClass('is-invalid');
        $('.text-danger').text('');

        // Show field-specific errors
        Object.keys(errors).forEach(field => {
            const errorElement = $('#' + field + 'Error');
            const inputElement = $('#' + field);
            if (errorElement.length && inputElement.length) {
                inputElement.addClass('is-invalid');
                errorElement.text(errors[field]);
            }
        });

        // Show general error if no field-specific errors shown
        if (Object.keys(errors).length === 0) {
            showClientError('Please check your input and try again.');
        }
    }

    function showClientError(message) {
        $('#clientResult').html(
            '<div class="alert alert-error">‚ùå ' + message + '</div>'
        );
    }

    function showClientSuccess(message) {
        $('#clientResult').html(
            '<div class="alert alert-success">‚úÖ ' + message + '</div>'
        );
    }

    // Handle browser back/forward buttons
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            const token = localStorage.getItem('token');
            if (token) {
                validateTokenAndRedirect(token);
            }
        }
    });
</script>
</body>
</html>